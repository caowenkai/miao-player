# 故障排查指南

## 音乐播放问题排查

### 问题：上传的音乐无法播放

#### 解决方案：

我已经修复了以下问题：

1. **✅ 播放器首页自动加载歌曲**
   - 现在打开播放器页面，会自动加载第一个歌单的歌曲
   - 如果没有歌单，会加载所有已上传的歌曲
   - 歌曲信息会自动显示在播放器界面

2. **✅ 修复了音频文件路径**
   - 后端静态文件路径已修正
   - 确保音频文件可以正确访问

3. **✅ 优化了播放控制**
   - 添加了错误处理
   - 防止浏览器自动播放限制导致的错误

### 测试步骤：

#### 第一步：重启服务

由于修改了代码，需要重启服务：

```bash
# 如果正在运行，先停止（Ctrl+C）

# 然后重新启动
bash start-dev.sh
```

#### 第二步：上传音乐

1. 访问后台管理：http://localhost:5174
2. 点击"音乐管理"
3. 点击"上传音乐"
4. 选择一个音频文件（mp3, wav, flac, m4a, ogg）
5. 点击"确定上传"
6. 上传成功后，点击"试听"测试是否能播放

#### 第三步：创建歌单（可选）

1. 点击"歌单管理"
2. 点击"创建歌单"
3. 输入歌单名称
4. 点击"确定"
5. 在歌单列表中，点击"添加歌曲"
6. 搜索并勾选要添加的歌曲
7. 点击"确定添加"

#### 第四步：在应用端播放

1. 访问应用端：http://localhost:5173
2. 现在播放器首页应该自动显示歌曲信息
3. 点击播放按钮▶️开始播放
4. 如果有多首歌，可以点击⏭️切换下一曲

### 常见问题排查

#### 问题1：播放器显示"暂无播放"

**可能原因：**
- 还没有上传音乐
- 还没有创建歌单

**解决方法：**
1. 先去后台管理上传至少一首音乐
2. 创建一个歌单并添加歌曲
3. 刷新应用端页面

#### 问题2：点击播放按钮没反应

**检查步骤：**
1. 打开浏览器控制台（F12）
2. 查看 Console 标签是否有错误信息
3. 查看 Network 标签，检查音频文件是否成功加载

**常见错误：**
- `404 Not Found` - 音频文件不存在，检查 uploads 目录
- `CORS Error` - 跨域问题，检查后端是否启动
- `Failed to load` - 文件格式不支持或损坏

#### 问题3：音频文件加载失败

**检查清单：**
```bash
# 1. 检查 uploads 目录是否存在
ls -la uploads/

# 2. 检查后端服务是否运行
curl http://localhost:3000/api/health

# 3. 检查音频文件是否上传成功
ls -la uploads/
# 应该能看到类似 1234567890.mp3 这样的文件

# 4. 测试音频文件是否可访问
# 假设文件名是 1234567890.mp3
curl -I http://localhost:3000/uploads/1234567890.mp3
# 应该返回 200 OK
```

#### 问题4：浏览器阻止自动播放

**说明：**
现代浏览器会阻止没有用户交互的自动播放。

**解决方法：**
- 用户必须手动点击播放按钮才能开始播放
- 这是正常的安全限制

### 调试技巧

#### 1. 查看后端日志

后端控制台会显示请求日志：
```
GET /api/songs 200
GET /api/playlists 200
GET /uploads/1234567890.mp3 200
```

#### 2. 查看前端日志

浏览器控制台（F12 → Console）会显示：
- API 请求结果
- 播放错误信息
- 加载状态

#### 3. 测试 API

使用浏览器或 curl 测试：

```bash
# 获取所有歌曲
curl http://localhost:3000/api/songs

# 获取所有歌单
curl http://localhost:3000/api/playlists

# 获取歌单详情（假设 ID 为 1）
curl http://localhost:3000/api/playlists/1

# 测试音频文件访问（替换为实际文件名）
curl -I http://localhost:3000/uploads/YOUR_FILE_NAME.mp3
```

### 如果问题仍未解决

1. **清除浏览器缓存**
   - 按 Ctrl+Shift+R (Windows/Linux)
   - 按 Cmd+Shift+R (Mac)

2. **检查文件权限**
   ```bash
   chmod 755 uploads/
   chmod 644 uploads/*.mp3
   ```

3. **重新安装依赖**
   ```bash
   cd backend && rm -rf node_modules && npm install
   cd ../frontend-app && rm -rf node_modules && npm install
   ```

4. **重置数据库**
   ```bash
   rm backend/data/database.db
   # 重启后端，数据库会自动重建
   ```

5. **查看完整日志**
   - 检查后端控制台输出
   - 检查浏览器控制台 (F12)
   - 检查 Network 标签的请求详情

### 成功标志

当一切正常时，你应该能看到：

1. **后台管理**
   - ✅ 可以成功上传音乐
   - ✅ 点击试听能播放
   - ✅ 可以创建歌单
   - ✅ 可以添加歌曲到歌单

2. **应用端**
   - ✅ 播放器首页自动显示歌曲信息
   - ✅ 点击播放按钮开始播放
   - ✅ 进度条随播放前进
   - ✅ 可以拖动进度条
   - ✅ 上一曲/下一曲按钮正常工作

3. **浏览器控制台**
   - ✅ 没有红色错误信息
   - ✅ Network 标签显示音频文件 200 OK
   - ✅ 可以看到音频文件加载进度

## 需要更多帮助？

如果以上步骤都无法解决问题，请：

1. 截图浏览器控制台的错误信息
2. 复制后端控制台的输出
3. 说明具体的操作步骤和现象
4. 提供音频文件格式和大小信息

---

**提示：** 大多数播放问题都是由于文件路径配置或浏览器安全限制造成的。按照上述步骤逐一检查，通常都能解决问题。

